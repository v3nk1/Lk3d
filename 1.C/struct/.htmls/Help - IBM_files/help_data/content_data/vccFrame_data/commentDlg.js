var timer=null; dojo.declare("vcc.comment.CommentAjax",null,{sendComment:function(_1,_2){ if("page"==_1.type){ var _3=_1.target.indexOf("?"); if(_3>0){ _1.target=_1.target.substring(0,_3); } } var _4="CommentServlet"; var _5={subject:_2.subject,text:_2.text,pid:_2.parentCommentID,pageid:_2.pageID,htmlid:_1.asString(),type:_2.typeid,notifyextra:_2.notifyextra,version:_2.pluginVersion,contentLocale:_2.contentLocale,limitSubjectBytesAmount:_2.limitSubjectBytesAmount,limitContentBytesAmount:_2.limitContentBytesAmount,bTimezone:vccUtils.getTimezoneName(),sessionid:sessionID}; _5.uniquerequestid=new Date().getTime(); commentDlg.disableSubmitButtons(); dojo.xhrPost({url:_4,content:_5,handleAs:"xml",load:function(_6,_7){ var _8; commentDlg.enableSubmitButtons(); try{ if(_7.xhr.status==200){ if(_6!=null){ if(_6.getElementsByTagName("error").length!=0){ if(_6.getElementsByTagName("error")[0].firstChild.nodeValue=="Session timeout"){ alert(nlsStrings.ALERT_TIMEOUT_RELOAD); window.top.location.reload(); }else{ commentView.refreshComments(function(){ commentContent.selectFragmentAndDisplayComment(commentTarget); }); if(_6.getElementsByTagName("error")[0].firstChild.nodeValue=="dbError"){ var _9=nlsStrings.ALERT_COMMENT_CONTENT_TOO_LONG; alert(dojo.string.substitute(_9,{amount:limitContentBytesAmount})); }else{ if(_6.getElementsByTagName("error")[0].firstChild.nodeValue=="unserver"){ alert(nlsStrings.ALERT_SUBMIT_FAIL); }else{ alert(_6.getElementsByTagName("error")[0].firstChild.nodeValue); } } } }else{ _8=_6.getElementsByTagName("comment")[0]; var _a=cmtUtil.getElementText(_8,"htmlID"); var _b=cmtUtil.getElementText(_8,"subject"); var _c=cmtUtil.getElementText(_8,"text"); var _d=cmtUtil.getElementText(_8,"uid"); var _e=cmtUtil.getElementText(_8,"intranetID"); var _f=cmtUtil.getElementText(_8,"nickName"); var _10=cmtUtil.getElementText(_8,"timestamp"); var _11=cmtUtil.getElementText(_8,"typeID"); var _12=cmtUtil.getElementText(_8,"dispositionID"); var cid=cmtUtil.getElementText(_8,"cid"); var pid=cmtUtil.getElementText(_8,"pid"); var _15=commentContent.createSelection(decodeURIComponent(_a)); commentDlg.hide(); commentView.insertComment(_b,_c,_d,_e,_f,_10,_11,_12,cid,pid,_15); commentView.updateCommentAmount(); commentContent.refreshMode(); } } }else{ alert(nlsStrings.ALERT_SUBMIT_FAIL); } } catch(e){ alert(nlsStrings.ALERT_SUBMIT_FAIL); } }}); }}); dojo.declare("vcc.comment.CommentDialog",null,{submittingIMG:"images/submiting.gif",submitIMG:"images/submit.gif",historyContent:"",historySubject:"",_parentID:0,commentTarget:null,show:function(_16,_17,pid){ this.commentTarget=commentContent.getSelection(); if(!this.commentTarget){ return; }else{ if("new"==_16){ var _19=null; if(this.commentTarget.type=="element"){ _19=nlsStrings.TITLE_ELEMENT; }else{ if(this.commentTarget.type=="page"){ _19=nlsStrings.TITLE_TOPIC; }else{ if(this.commentTarget.type=="free"){ _19=nlsStrings.TITLE_SELECTION; }else{ _19=nlsStrings.TITLE_UNKONWTARGET; } } } var _1a=nlsStrings.ADD_COMMENT_ON; dijit.byId("addcomment").titleNode.innerHTML=dojo.string.substitute(_1a,{type:_19,username:dijit.byId("addcomment").title}); }else{ if("reply"==_16){ cmtDisplay.clearHighlight(); var _1a=nlsStrings.REPLY_COMMENT; dijit.byId("addcomment").titleNode.innerHTML=dojo.string.substitute(_1a,{title:dijit.byId("addcomment").title}); } } } dijit.byId("addcomment").closeButtonNode.style.display="none"; commentContent.ContentViewFrame.content.disableClickHandler(); if(pid){ this._parentID=pid; }else{ this._parentID=0; } try{ theVccFrame.rowsSetting=theVccFrame.frameSet.getAttribute("rows"); var _1b=theVccFrame.rowsSetting.substring(theVccFrame.rowsSetting.lastIndexOf(",")+1); if(_1b<400){ theVccFrame.frameSet.setAttribute("rows","24,*,400"); } var _1c=document.getElementById("commentsubject"); if(_17){ _1c.value=cmtUtil.decodeComment(decodeURIComponent(_17)); }else{ _1c.value=""; } var _1d=document.getElementById("commenttext"); _1d.value=""; var _1e=dijit.byId("typeSelector"); if(_1e){ _1e.setValue("0"); } document.getElementById("notifyextra").value=""; dijit.byId("addcomment").show(); _1c.focus(); } catch(e){ console.dir(e); } try{ var _1f=document.getElementById("notify_tr_2"); var _20=document.getElementById("commentTypeTR"); if(!isInternalMode){ _1f.style.display="none"; _20.style.display="none"; }else{ _1f.style.display=""; } } catch(e){ console.dir(e); } },getRatingResult:function(){ var _21=document.getElementsByName("ratingRadio"); for(var _22=0;_22<_21.length;_22++){ if(_21[_22].checked){ return _21[_22].value; } } return -1; },submit:function(){ dojo.byId("addcomment_btn").focus(); var _23=vccUtils.trimString(this.getSubject()); if(cmtUtil.validateSubject(_23,limitSubjectBytesAmount)!=0){ return; } var _24=vccUtils.trimString(this.getText()); if(cmtUtil.validateComment(_24,limitContentBytesAmount)!=0){ return; } var _25=dijit.byId("typeSelector"); if(_25&&cmtUtil.validateType(_25)!=0){ return; } var _26={pageID:commentContent.getPageID(),parentCommentID:this._parentID,typeid:this.getType(),text:_24,subject:_23,pluginVersion:commentContent.getPluginVersion(),notifyextra:this.getNotifyExtra(),contentLocale:commentContent.getContentLocale(),limitSubjectBytesAmount:limitSubjectBytesAmount,limitContentBytesAmount:limitContentBytesAmount}; var _27=new vcc.comment.CommentAjax(); _27.sendComment(this.commentTarget,_26); if(document.getElementById("delete_label"+this._parentID)){ document.getElementById("delete_label"+this._parentID).innerHTML=""; document.getElementById("delete_label"+this._parentID).style.display="none"; } },cancel:function(){ this.hide(); this.cancelLinkDialog(); },hide:function(_28){ if(dijit&&dijit.byId("addcomment")){ dijit.byId("addcomment").hide(); if(!_28){ if(!theVccFrame.vccFrame.noResize){ var _29=theVccFrame.rowsSetting.substring(theVccFrame.rowsSetting.lastIndexOf(",")+1); if(_29<250){ theVccFrame.frameSet.setAttribute("rows","24,*,250"); }else{ theVccFrame.frameSet.setAttribute("rows",theVccFrame.rowsSetting); } } } } commentContent.ContentViewFrame.content.enableClickHandler(); },linkToNick:function(){ this.hide(); commentContent.setUrl("../vcc/admin.jsp"); },getSubject:function(){ return document.getElementById("commentsubject").value; },getText:function(){ return document.getElementById("commenttext").value; },getType:function(){ if(!isInternalMode){ return 0; } var _2a=dijit.byId("typeSelector"); if(null!=_2a){ return _2a.value; }else{ return typeList.length-1; } },getNotifyExtra:function(){ return document.getElementById("notifyextra").value; },enableSubmitButtons:function(){ dijit.byId("submitcomment").setAttribute("disabled",false); dijit.byId("cancelbutton").setAttribute("disabled",false); },disableSubmitButtons:function(){ dijit.byId("submitcomment").setAttribute("disabled",true); dijit.byId("cancelbutton").setAttribute("disabled",true); },emptyHandler:function(_2b,_2c,arg,_2e){ if(_2b.length==0){ alert(nlsStrings.ALERT_ENTER_SUBJECT); return true; } if(_2c.length==0){ alert(nlsStrings.ALERT_BLANK_MESSAGE); return true; } return false; },validate:function(){ if(dojo.byId("element").checked==true&&commentContent.getSelection()==null){ alert(nlsStrings.ALERT_ELEMENT_SELECT); } },limitContentText:function(_2f,_30){ var _31=document.getElementById(_2f).value; var _32=_31.xmlEncode().bLength(); if(_32>_30&&_32>this.historyContent.xmlEncode().bLength()){ this.historyContent=_31; var _33=nlsStrings.ALERT_COMMENT_CONTENT_TOO_LONG; alert(dojo.string.substitute(_33,{amount:_30})); } },limitSubjectText:function(_34,_35){ var _36=document.getElementById(_34).value; var _37=_36.xmlEncode().bLength(); if(_37>_35&&_37>this.historySubject.xmlEncode().bLength()){ this.historySubject=_36; var _38=nlsStrings.ALERT_COMMENT_SUBJECT_TOO_LONG; alert(dojo.string.substitute(_38,{amount:_35})); } },setCaret:function(_39,pos){ if(_39.setSelectionRange){ var end=_39.value.length; _39.focus(); _39.setSelectionRange(end+pos,end+pos); }else{ var _3c=_39.createTextRange(); _3c.collapse(false); _3c.moveEnd("character",pos); _3c.select(); } },insertTag:function(_3d,_3e){ var end=0; var _40=0; if(document.selection){ var _41=document.selection.createRange(); var _42=_41.duplicate(); _42.moveToElementText(_3d); _42.setEndPoint("EndToEnd",_41); _3d.selectionStart=_42.text.length-_41.text.length; _3d.selectionEnd=_3d.selectionStart+_41.text.length; if(_3d.selectionStart==_3d.selectionEnd){ _3d.value+="<"+_3e+">"+"</"+_3e+">"; this.setCaret(_3d,-4); }else{ end=_3d.selectionEnd; _3d.value=_3d.value.substring(0,_3d.selectionStart)+"<"+_3e+">"+_3d.value.substring(_3d.selectionStart,end)+"</"+_3e+">"+_3d.value.substring(end,_3d.value.length); _40=end-_3d.value.length+3; this.setCaret(_3d,_40); } }else{ if(_3d.setSelectionRange){ if(_3d.selectionStart==_3d.selectionEnd){ _3d.value+="<"+_3e+">"+"</"+_3e+">"; this.setCaret(_3d,-4); }else{ end=_3d.selectionEnd; _3d.value=_3d.value.substring(0,_3d.selectionStart)+"<"+_3e+">"+_3d.value.substring(_3d.selectionStart,end)+"</"+_3e+">"+_3d.value.substring(end,_3d.value.length); _40=end-_3d.value.length+3; this.setCaret(_3d,_40); } } } },setFontBold:function(){ var _43=document.getElementById("commenttext"); this.insertTag(_43,"b"); this.limitContentText("commenttext",limitContentBytesAmount); },setFontItalic:function(){ var _44=document.getElementById("commenttext"); this.insertTag(_44,"i"); this.limitContentText("commenttext",limitContentBytesAmount); },insertLink:function(url,_46){ var _47=document.getElementById(url); var _48=document.getElementById(_46); var _49=/^[a-zA-z]+:\/\/\S+$/; if(!_49.test(_47.value)){ alert(nlsStrings.ALERT_INVALID_URL); _47.focus(); return true; } if(_48.value.length==0){ alert(nlsStrings.ALERT_NEED_TITLE); _48.focus(); return true; } document.getElementById("dialogLink").style.display="none"; var _4a=document.getElementById("commenttext"); var _4b="<a href='"+_47.value+"'>"+_48.value+"</a>"; _4a.value+=_4b; this.limitContentText("commenttext",limitContentBytesAmount); this.setCaret(_4a,0); _47.value="http://"; _48.value=""; this.removeSubmitBtn(); },showLinkDialog:function(){ dojo.byId("dialogLink").style.display="block"; dojo.byId("dialogLink.linkUrl").focus(); dojo.byId("dialogLink.linkUrl").value="http://"; var _4c=dojo.byId("urlLabel").innerHTML.length; var _4d=dojo.byId("titleLabel").innerHTML.length; _4c=_4c>_4d?_4c:_4d; dojo.byId("dialogLink").style.width=(285+_4c*3)+"px"; this.createSubmitBtn(); var _4e=true; var _4f=dojo.connect(dijit.byId("addcomment").containerNode,"onkeypress",function(evt){ if(evt.keyCode==dojo.keys.ESCAPE&&dojo.byId("dialogLink").style.display=="none"&&_4e){ dojo.stopEvent(evt); } if(dojo.byId("dialogLink").style.display=="none"){ _4e=false; } }); dojo.connect(dojo.byId("dialogLink"),"onkeypress",function(evt){ if(evt.keyCode==dojo.keys.ESCAPE){ dojo.byId("dialogLink.linkUrl").value="http://"; dojo.byId("dialogLink.linkTitle").value=""; dojo.byId("commenttext").focus(); dojo.byId("dialogLink").style.display="none"; } }); },cancelLinkDialog:function(){ document.getElementById("dialogLink").style.display="none"; document.getElementById("dialogLink.linkUrl").value="http://"; document.getElementById("dialogLink.linkTitle").value=""; var _52=document.getElementById("commenttext"); _52.focus(); this.setCaret(_52,0); this.removeSubmitBtn(); },createSubmitBtn:function(){ this.removeSubmitBtn(); var _53=new dijit.form.Button({label:nlsStrings.LABEL_OK,type:"submit",onClick:function(){ commentDlg.insertLink("dialogLink.linkUrl","dialogLink.linkTitle"); }}); dojo.byId("buttonDiv").appendChild(_53.domNode); },removeSubmitBtn:function(){ var _54=dojo.byId("buttonDiv"); if(_54.firstChild){ var _55=_54.cloneNode(false); _54.parentNode.replaceChild(_55,_54); } }}); dojo.declare("vcc.comment.DispositionDialog",null,{show:function(_56){ this._dispComment=_56; theVccFrame.rowsSetting=theVccFrame.frameSet.getAttribute("rows"); var _57=theVccFrame.rowsSetting.substring(theVccFrame.rowsSetting.lastIndexOf(",")+1); if(_57<300){ theVccFrame.frameSet.setAttribute("rows","24,*,300"); } dijit.byId("changeDisposition").show(); },submit:function(){ var _58="CommentServlet?changedisp="; var _59=dojo.byId("dispositionSelection"); _58+="_"+this._dispComment.cid+"_"+_59.options[_59.selectedIndex].value; _58+="&sessionid="+sessionID; _59.disabled=true; dojo.xhrGet({url:_58+"&uniquerequestid="+new Date().getTime(),load:function(_5a,_5b){ dispositionDlg.updateDisp(); }}); },hide:function(){ dijit.byId("changeDisposition").hide(); if(!theVccFrame.vccFrame.noResize){ theVccFrame.frameSet.setAttribute("rows",theVccFrame.rowsSetting); } },cancel:function(){ this.hide(); },updateDisp:function(){ var _5c=dojo.byId("dispositionSelection"); this._dispComment.disposition=_5c.selectedIndex; var _5d=dojo.byId("comment_disposition"+this._dispComment.cid); _5d.innerHTML="<a href='javascript:void(0);'>"+dispositionList[this._dispComment.disposition]+"</a>"; dijit.byId("changeDisposition").hide(); }}); 