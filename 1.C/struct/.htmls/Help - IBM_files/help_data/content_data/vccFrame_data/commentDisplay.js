dojo.declare("vcc.comment.CommentDisplay",null,{notScrollComment:false,commentTrees:[],initTree:function(_1){ for(var i in _1){ var _3=_1[i]._generateTree(); for(var j=0;j<_3.length;++j){ this.commentTrees[this.commentTrees.length]=_3[j]; } } var _5=document.getElementById("comment_table_body"); for(var i in this.commentTrees){ var _6=false; if(this.commentTrees[i].childs.length>0){ _6=true; } this.traverse4amountAndlastModifyTime(this.commentTrees[i]); this.addToCommentTable(_5,this.commentTrees[i],_6); } cmtUtil.newWindowLinks(); this.sortByTimeDesc(); },changeTipImages:function(_7,_8){ if(_7=="rest"){ _8.src="../../../../../../vcc/images/cd_nosort.gif"; }else{ _8.src="../vcc/images/cd_nosort.gif"; } },delete_sort_tip:function(_9){ var _a=document.getElementById("level_tip"); if(_a){ this.changeTipImages(_9,_a); } _a=document.getElementById("title_tip"); if(_a){ this.changeTipImages(_9,_a); } _a=document.getElementById("disposition_tip"); if(_a){ this.changeTipImages(_9,_a); } _a=document.getElementById("added_by_tip"); if(_a){ this.changeTipImages(_9,_a); } _a=document.getElementById("time_tip"); if(_a){ this.changeTipImages(_9,_a); } _a=document.getElementById("amount_tip"); if(_a){ this.changeTipImages(_9,_a); } },refresh_comment_table:function(){ var _b=document.getElementById("comment_table_body"); var _c=_b.parentNode; _c.removeChild(_b); _b=document.createElement("tbody"); _b.id="comment_table_body"; _c.appendChild(_b); this.commentTrees=[]; this.delete_sort_tip(); },sortBy:function(_d,_e){ var _f=document.getElementById("comment_dis_table"); var _10=[]; for(var _11=0;_11<_f.tBodies.length;_11++){ if(_f.tBodies[_11].className){ _10.push(_f.tBodies[_11]); } } if("desc"==_e){ _10.sort(_d); }else{ _10.sort(function(a,b){ return -1*_d(a,b); }); } for(var _11=0;_11<_10.length;_11++){ _f.removeChild(_10[_11]); _f.appendChild(_10[_11]); } },sortByTitle:function(_14){ this.delete_sort_tip(_14); var _15=function(a,b){ var _18=a.firstChild.childNodes[2].firstChild.innerHTML; var _19=b.firstChild.childNodes[2].firstChild.innerHTML; _18=_18.toLowerCase(); _19=_19.toLowerCase(); if(_18==_19){ return 0; } if(_18>_19){ return 1; }else{ return -1; } }; var _1a=document.getElementById("comment_title_p"); if(_1a){ if(_14=="rest"){ document.getElementById("title_tip").src="../../../../../../vcc/images/ascending.gif"; }else{ document.getElementById("title_tip").src="../vcc/images/ascending.gif"; } _1a.id="comment_title_m"; this.sortBy(_15,"asc"); }else{ _1a=document.getElementById("comment_title_m"); _1a.id="comment_title_p"; if(_14=="rest"){ document.getElementById("title_tip").src="../../../../../../vcc/images/descending.gif"; }else{ document.getElementById("title_tip").src="../vcc/images/descending.gif"; } this.sortBy(_15,"desc"); } },sortByDisposition:function(_1b){ this.delete_sort_tip(_1b); var _1c=function(a,b){ var _1f=a.firstChild.childNodes[3].firstChild.innerHTML; var _20=b.firstChild.childNodes[3].firstChild.innerHTML; _1f=_1f.toLowerCase(); _20=_20.toLowerCase(); if(_1f==_20){ return 0; } if(_1f>_20){ return 1; }else{ return -1; } }; var _21=document.getElementById("comment_disposition_p"); if(_21){ if(_1b=="rest"){ document.getElementById("disposition_tip").src="../../../../../../vcc/images/ascending.gif"; }else{ document.getElementById("disposition_tip").src="../vcc/images/ascending.gif"; } _21.id="comment_disposition_m"; this.sortBy(_1c,"asc"); }else{ _21=document.getElementById("comment_disposition_m"); _21.id="comment_disposition_p"; if(_1b=="rest"){ document.getElementById("disposition_tip").src="../../../../../../vcc/images/descending.gif"; }else{ document.getElementById("disposition_tip").src="../vcc/images/descending.gif"; } this.sortBy(_1c,"desc"); } },sortByAmount:function(_22){ this.delete_sort_tip(_22); var _23=function(a,b){ var _26=Number(a.firstChild.lastChild.innerHTML)-Number(b.firstChild.lastChild.innerHTML); if(_26==0){ return 0; } if(_26>0){ return 1; }else{ return -1; } }; var _27=document.getElementById("comment_amount_p"); if(_27){ if(_22=="rest"){ document.getElementById("amount_tip").src="../../../../../../vcc/images/ascending.gif"; }else{ document.getElementById("amount_tip").src="../vcc/images/ascending.gif"; } _27.id="comment_amount_m"; this.sortBy(_23,"asc"); }else{ _27=document.getElementById("comment_amount_m"); _27.id="comment_amount_p"; if(_22=="rest"){ document.getElementById("amount_tip").src="../../../../../../vcc/images/descending.gif"; }else{ document.getElementById("amount_tip").src="../vcc/images/descending.gif"; } this.sortBy(_23,"desc"); } },sortByLevel:function(_28){ this.delete_sort_tip(_28); var _29=function(a,b){ var _2c=a.className.lastIndexOf("-"); var _2d=b.className.lastIndexOf("-"); var _2e=a.className.substr(_2c+1); var _2f=b.className.substr(_2d+1); if(_2e==_2f){ return 0; } if(_2e>_2f){ return 1; }else{ return -1; } }; var _30=document.getElementById("comment_level_p"); if(_30){ if(_28=="rest"){ document.getElementById("level_tip").src="../../../../../../vcc/images/ascending.gif"; }else{ document.getElementById("level_tip").src="../vcc/images/ascending.gif"; } _30.id="comment_level_m"; this.sortBy(_29,"asc"); }else{ _30=document.getElementById("comment_level_m"); _30.id="comment_level_p"; if(_28=="rest"){ document.getElementById("level_tip").src="../../../../../../vcc/images/descending.gif"; }else{ document.getElementById("level_tip").src="../vcc/images/descending.gif"; } this.sortBy(_29,"desc"); } },sortByUser:function(_31){ this.delete_sort_tip(_31); var _32=function(a,b){ var _35=a.firstChild.lastChild.previousSibling.previousSibling.firstChild.innerHTML; var _36=b.firstChild.lastChild.previousSibling.previousSibling.firstChild.innerHTML; _35=_35.toLowerCase(); _36=_36.toLowerCase(); if(_35==_36){ return 0; } if(_35>_36){ return 1; }else{ return -1; } }; var _37=document.getElementById("added_by_p"); if(_37){ _37.id="added_by_m"; if(_31=="rest"){ document.getElementById("added_by_tip").src="../../../../../../vcc/images/ascending.gif"; }else{ document.getElementById("added_by_tip").src="../vcc/images/ascending.gif"; } this.sortBy(_32,"asc"); }else{ _37=document.getElementById("added_by_m"); _37.id="added_by_p"; if(_31=="rest"){ document.getElementById("added_by_tip").src="../../../../../../vcc/images/descending.gif"; }else{ document.getElementById("added_by_tip").src="../vcc/images/descending.gif"; } this.sortBy(_32,"desc"); } },sortByTimeDesc:function(_38){ this.delete_sort_tip(_38); var _39=function(a,b){ var _3c=new Date(a.firstChild.childNodes[4].innerHTML); var _3d=new Date(b.firstChild.childNodes[4].innerHTML); if(Date.parse(_3c)-Date.parse(_3d)==0){ return 0; } if(Date.parse(_3c)-Date.parse(_3d)<0){ return 1; }else{ return -1; } }; var _3e=document.getElementById("comment_time_p"); if(_3e){ this.sortBy(_39,"desc"); }else{ this.sortBy(_39,"asc"); } },sortByTime:function(_3f){ this.delete_sort_tip(_3f); var _40=function(a,b){ var _43=a.firstChild.lastChild.previousSibling.innerHTML.replace(/[^\w\/\:\-\,\.]/g," ").replace(/-/g,"/").replace(/\./g,"/"); var _44=b.firstChild.lastChild.previousSibling.innerHTML.replace(/[^\w\/\:\-\,\.]/g," ").replace(/-/g,"/").replace(/\./g,"/"); var _45=new Date(_43); var _46=new Date(_44); if(Date.parse(_45)-Date.parse(_46)==0){ return 0; } if(Date.parse(_45)-Date.parse(_46)<0){ return 1; }else{ return -1; } }; var _47=document.getElementById("comment_time_p"); if(_47){ _47.id="comment_time_m"; if(_3f=="rest"){ document.getElementById("time_tip").src="../../../../../../vcc/images/ascending.gif"; }else{ document.getElementById("time_tip").src="../vcc/images/ascending.gif"; } this.sortBy(_40,"asc"); }else{ _47=document.getElementById("comment_time_m"); _47.id="comment_time_p"; if(_3f=="rest"){ document.getElementById("time_tip").src="../../../../../../vcc/images/descending.gif"; }else{ document.getElementById("time_tip").src="../vcc/images/descending.gif"; } this.sortBy(_40,"desc"); } },showchilds_table:function(_48){ this.clearHighlight(); var _49=_48.parentNode.parentNode.parentNode; var _4a=_49.className; if(_4a.indexOf("commentThread-nonechild")>-1){ return; } if(_4a.indexOf("commentThread-expanded")>-1){ _49.className=_4a.replace("commentThread-expanded","commentThread-collapsed"); }else{ if(_4a.indexOf("commentThread-collapsed")>-1){ _49.className=_4a.replace("commentThread-collapsed","commentThread-expanded"); _49.firstChild.className="highlighted"; } } var tr=_48.parentNode.parentNode; commentContent.selectFragment(tr.htmlID); },traverse4amountAndlastModifyTime:function(_4c){ if(_4c.childs.length>0){ for(var _4d in _4c.childs){ this.traverse4amountAndlastModifyTime(_4c.childs[_4d]); } for(var a_i in _4c.childs){ _4c.amount+=_4c.childs[a_i].amount; _4c.lastModifyTime=new Date(_4c.lastModifyTime)>new Date(_4c.childs[a_i].lastModifyTime)?_4c.lastModifyTime:_4c.childs[a_i].lastModifyTime; } } },updateAmountAndTime:function(_4f,_50){ var _51=document.getElementById(_4f.cid); while(true){ if("TR"==_51.tagName){ break; } _51=_51.parentNode; } var _52=_51.previousSibling.lastChild; _52.innerHTML=parseInt(_52.innerHTML)+_50; var _53=_52.previousSibling; _53.innerHTML=_4f.time; },addToCommentTable:function(_54,_55,_56){ var _57=document.createElement("tr"); _57.className="even"; _57.htmlID=_55.htmlID; var _58=document.createElement("td"); var _59=document.createElement("td"); var _5a=document.createElement("td"); var _5b=document.createElement("td"); var _5c=document.createElement("td"); var _5d=document.createElement("td"); _58.innerHTML="<a href='javascript:void(0)' onClick='cmtDisplay.showchilds_table(this);'>"; _58.innerHTML+="<div class='commentThread-sign-image' onClick='cmtDisplay.showchilds_table(this);' >"; _58.innerHTML+="</a>"; _58.axis="comment_level"; _58.headers="comment_level"; _57.appendChild(_58); _59.innerHTML="<div class='commentThread-level-image'></div>"; _59.axis="comment_level"; _59.headers="comment_catalog"; _57.appendChild(_59); _5a.headers="comment_title"; _5a.axis="comment_text"; _5a.className="comment_table_text"; _5a.innerHTML="<a href='javascript:void(0);'>"+_55.subject+" </a>"; _5a.onclick=function(){ cmtDisplay.showchilds_table(this.previousSibling.firstChild); }; _57.appendChild(_5a); if(isInternalMode||!(isAnonymous||isReviewer)){ var _5e=document.createElement("td"); var _5f=0; if(isIE){ _5f=dispositionList.length-2; }else{ _5f=dispositionList.length-1; } _5e.axis="comment_disposition"; _5e.id="comment_disposition"+_55.cid; _5e.headers="comment_disposition"; _5e.className="comment_disposition_a"; if(_55.disposition!=_5f&&(userRight.test(AU.MASK.DISPOSITION))){ _5e.title=nlsStrings.TITLE_DISPOSITION; _5e.innerHTML="<a href='javascript:void(0);'>"+dispositionList[_55.disposition]+"</a>"; _5e.name=_55.cid; _5e.onclick=function(){ commentActions.changeDisp(_5e); }; }else{ _5e.innerHTML="<span>"+dispositionList[_55.disposition]+"</span>"; } _57.appendChild(_5e); } var _60; if(""!=_55.nickName){ _60=_55.nickName; }else{ _60=_55.intranetID; if(!isInternalMode){ var _61=_60.indexOf("@"); if(-1!=_61){ _60=_60.substring(0,_61+1); _60=_60.concat("***.**"); } } } var _62=_60.substring(0,20)+(_60.length>=20?"...":""); _5b.headers="added_by"; _5b.axis="added_by_a"; _5b.className="added_by_a"; _5b.title=_60; _5b.innerHTML="<a href='javascript:void(0);' onclick='javascript:commentActions.showOthersComments(\""+_55.uid+"\",\""+_55.intranetID+"\",\""+_60+"\");'>"+_62+"</a>"; _57.appendChild(_5b); _5c.headers="comment_time"; _5c.axis="time_a"; _5c.className="time_a"; var _63=_55.lastModifyTime; _5c.innerHTML=_63; _57.appendChild(_5c); _5d.headers="comment_amount"; _5d.axis="amount_a"; _5d.className="amount_a"; _5d.innerHTML=_55.amount-1; _57.appendChild(_5d); var _64=document.createElement("tbody"); if("page"==_55.htmlID.type){ _64.className="commentThread-collapsed commentThread-page"; }else{ if("element"==_55.htmlID.type){ _64.className="commentThread-collapsed commentThread-element"; }else{ if("free"==_55.htmlID.type){ _64.className="commentThread-collapsed commentThread-free"; } } } _64.appendChild(_57); var _65=document.createElement("tr"); var _66=document.createElement("td"); if(isInternalMode||!(isAnonymous||isReviewer)){ _66.colSpan="7"; }else{ _66.colSpan="6"; } _66.className="comment_tree_td"; this.attachCommentTree(_66,_55); _65.appendChild(_66); _64.appendChild(_65); if(_54){ _54.parentNode.appendChild(_64); }else{ alert("no such element1"); } },attachCommentTree:function(_67,_68){ var div=document.createElement("DIV"); if(_68.parentID==0){ div.className="pagecomment commentThread-body"; }else{ div.className="elementcomment commentThread-body"; } div.appendChild(this.generateChildTreeUI([_68])); _67.appendChild(div); },generateChildTreeUI:function(_6a){ var _6b=document.createElement("UL"); _6b.className="comments"; for(var _6c in _6a){ var _6d=_6a[_6c]; var _6e=document.createElement("LI"); _6e.id=_6d.cid; _6e.innerHTML=_6d.toHTML(_6d.childs.length>0); _6e.appendChild(this.generateChildTreeUI(_6d.childs)); _6b.appendChild(_6e); } return _6b; },addComment:function(_6f){ if(_6f.pid==0){ _6f.childs=new Array(); var _70=this.commentTrees.length; this.commentTrees[_70]=_6f; var _71=document.getElementById("comment_table_body"); this.addToCommentTable(_71,_6f,false); commentContent.selectFragment(_6f.htmlID); this.showSelectedComment(_6f.cid); }else{ this.appendCommentToTree(_6f); this.updateAmountAndTime(_6f,1); this.showSelectedComment(_6f.pid); this.showOrHideComment(_6f); cmtUtil.scrollComment(document.getElementById(_6f.cid)); } cmtUtil.newWindowLinks(); this.sortByTimeDesc(); },appendCommentToTree:function(_72){ var _73=document.getElementById(_72.pid); var ul=_73.lastChild; if(!ul||"UL"!=ul.tagName){ ul=document.createElement("UL"); ul.className="comments"; _73.appendChild(ul); } var li=document.createElement("LI"); li.id=_72.cid; li.innerHTML=_72.toHTML(false); ul.appendChild(li); },showOrHideComment:function(_76){ var _77=document.getElementById(_76.cid).firstChild.firstChild; commentActions.showOrHideComment(_77); },expandAll:function(){ var _78=document.getElementById("comment_dis_table").getElementsByTagName("tbody"); for(var _79=0;_79<_78.length;_79++){ var _7a=_78[_79].className; if(!_7a){ continue; } if(_7a.indexOf("commentThread-collapsed")>-1){ _78[_79].className=_7a.replace("commentThread-collapsed","commentThread-expanded"); } } },collapseAll:function(){ var _7b=document.getElementById("comment_dis_table").getElementsByTagName("tbody"); for(var _7c=0;_7c<_7b.length;_7c++){ var _7d=_7b[_7c].className; if(!_7d){ continue; } if(_7d.indexOf("commentThread-expanded")>-1){ _7b[_7c].className=_7d.replace("commentThread-expanded","commentThread-collapsed"); } } },expandThreadsByElementID:function(_7e){ this.collapseAll(); var _7f=false; var _80=document.getElementById("comment_dis_table").getElementsByTagName("tbody"); for(var _81=0;_81<_80.length;_81++){ var _82=_80[_81].className; if(!_82){ continue; } if(_80[_81].firstChild.htmlID!=_7e){ continue; } if(_82.indexOf("commentThread-collapsed")>-1){ _80[_81].className=_82.replace("commentThread-collapsed","commentThread-expanded"); } if(!_7f){ cmtUtil.scrollComment(_80[_81].firstChild); _7f=true; } } },highlightThreadsByElementID:function(_83){ this.clearHighlight(); var _84=false; var _85=document.getElementById("comment_dis_table").getElementsByTagName("tbody"); for(var _86=0;_86<_85.length;_86++){ var _87=_85[_86].className; if(!_87){ continue; } if(!_83.equals(_85[_86].firstChild.htmlID)){ continue; } _85[_86].firstChild.className="highlighted"; if(!_84){ if(!this.notScrollComment){ cmtUtil.scrollComment(_85[_86].firstChild); } _84=true; } } },clearHighlight:function(){ var _88=document.getElementById("comment_dis_table").getElementsByTagName("tbody"); for(var _89=0;_89<_88.length;_89++){ var _8a=_88[_89].className; if(!_8a){ continue; } _88[_89].firstChild.className="even"; } },showSelectedComment:function(cid){ this.collapseAll(); var _8c=document.getElementById(cid); while(true){ if("TR"==_8c.tagName){ break; } _8c=_8c.parentNode; } var _8d=_8c.parentNode; var _8e=_8d.className; if(!_8d||!_8e){ return; } if(_8e.indexOf("commentThread-collapsed")>-1){ _8d.className=_8e.replace("commentThread-collapsed","commentThread-expanded"); } _8c=document.getElementById(cid); var _8f=_8c.firstChild.firstChild; commentActions.showOrHideComment(_8f); cmtUtil.scrollComment(document.getElementById(cid)); }}); 