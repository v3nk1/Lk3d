var isMozilla=navigator.userAgent.indexOf("Mozilla")!=-1&&parseInt(navigator.appVersion.substring(0,1))>=5; var isIE=navigator.userAgent.indexOf("MSIE")!=-1; dojo.declare("vcc.content.Popup",null,{constructor:function(_1){ this._doc=_1; },show:function(_2){ if(!_2){ return; } var _3=this._doc.getElementById("imagmenu"); if(!_3){ _3=this._createIcon(); } _3.style.visibility="hidden"; var _4=_2; while(true){ if(_4.parentNode){ if(ContentCommon.isValidNode(_4.parentNode)){ var _5=this._getPosition(_2); var x=_5.x+_2.offsetWidth; var y=_5.y+_2.offsetHeight; _3.style.left=x+"px"; _3.style.top=y+"px"; _3.style.visibility="visible"; _3.goTarget=_4.parentNode; return; }else{ _4=_4.parentNode; } }else{ return; } } },hide:function(){ var _8=this._doc.getElementById("imagmenu"); if(_8){ _8.style.visibility="hidden"; } },_getPosition:function(_9){ var _a=_9; var _b={x:0,y:0}; do{ _b.x+=_a.offsetLeft; _b.y+=_a.offsetTop; _a=_a.offsetParent; }while(_a.tagName!="BODY"); return _b; },_createIcon:function(){ var _c=this._doc.createElement("DIV"); _c.vcc_noparse=true; _c._vccpopup=true; _c.id="imagmenu"; _c.style.position="absolute"; _c.style.visibility="hidden"; _c.style.width="20px"; _c.onmouseup=function(){ ContentCommon.onPopupClicked(this); }; var _d=this._doc.createElement("IMG"); _d.vcc_noparse=true; _d._vccpopup=true; _d.src=ContentCommon.prefix+"vcc/images/float.gif"; if(window.top.HelpFrame){ _d.title=window.top.HelpFrame.ContentFrame.vccFrames.nlsStrings.TIP_POPUP; } _c.appendChild(_d); this._doc.body.appendChild(_c); return _c; }}); dojo.declare("vcc.content.Highlighter",null,{_preSelection:null,_document:document,_freeSelector:null,_popup:null,constructor:function(_e,_f){ this._document=_e.document; this._freeSelector=_f; this._popup=new vcc.content.Popup(this._document); },highlightFragment:function(_10){ this.clearHighlight(); if(_10.type=="page"){ }else{ if(_10.type=="element"){ var ele=this._document.getElementById(_10.target); if(ele){ this._highlightNode(ele); } }else{ if(_10.type=="free"){ this._freeSelector.showSelection(_10.target); } } } this._preSelection=_10.clone(); },clearHighlight:function(){ this._freeSelector.clearSelection(); if(null==this._preSelection){ return; } if(this._preSelection.type=="page"){ }else{ if(this._preSelection.type=="element"){ var ele=this._document.getElementById(this._preSelection.target); if(ele){ this._unHighlightNode(ele); } }else{ if(this._preSelection.type=="free"){ } } } this._preSelection=null; },_highlightNode:function(_13){ if(null==_13){ return; } _13.vcc_save_background=_13.style.background; _13.vcc_save_backgroundColor=_13.style.backgroundColor; _13.vcc_save_color=_13.style.color; _13.vcc_save_backgroundImage=_13.style.backgroundImage; _13.vcc_save_backgroundPosition=_13.style.backgroundPosition; _13.style.background="#ffffcc"; _13.style.backgroundColor="#ffffcc"; _13.style.color="#000000"; _13.style.backgroundImage=_13.vcc_save_backgroundImage; _13.style.backgroundRepeat="no-repeat"; _13.style.backgroundPosition=_13.vcc_save_backgroundPosition; _13.accessKey="Y"; this._popup.show(_13); },_unHighlightNode:function(_14){ _14.style.background=_14.vcc_save_background; _14.style.backgroundColor=_14.vcc_save_backgroundColor; _14.style.color=_14.vcc_save_color; this._popup.hide(); }}); dojo.declare("vcc.base.Scroller",null,{_window:window,constructor:function(_15){ this._window=_15; },scrollToElement:function(_16){ if(_16<0){ return; }else{ var _17=this._window.document.getElementById(_16); this.scrollIntoView(_17); } },scrollIntoView:function(_18){ if(_18){ var _19=this._getVerticalScroll(_18); this._window.scrollTo(0,0); this._window.scrollBy(0,_19); _18.focus(); }else{ this._window.status="Can not find the element"; } },_getVerticalScroll:function(_1a){ if(_1a==null){ return 0; } var _1b=0; var _1c=0; var _1d=0; var _1e=_1a.offsetHeight; try{ if(_1a.offsetParent){ for(;_1a.offsetParent;_1a=_1a.offsetParent){ _1b+=_1a.offsetTop; } }else{ _1b=_1a.offsetTop; } } catch(e){ alert(e); } _1c=_1b+_1e; if(isIE){ _1d=this._window.document.documentElement.clientHeight; if(_1d==0){ _1d=this._window.document.body.clientHeight; } }else{ if(isMozilla){ _1d=this._window.innerHeight; } } var _1f=0; if(_1b>=0){ if(_1c<=_1d){ _1f=0; }else{ _1f=_1b; } }else{ _1f=_1b; } return _1f-(_1d/2); }}); dojo.declare("vcc.content.Marker",null,{_document:document,constructor:function(_20){ this._document=_20; },showMarkers:function(_21){ if(null==_21){ return; } for(var i in _21){ this._showMarker(_21[i]); } },_createMarker:function(){ var _23; if(isIE){ _23=this._document.createElement("<img name='vccmark'  onmouseover=\"this.style.cursor='pointer';this.style.cursor='hand'\">"); }else{ _23=this._document.createElement("img"); _23.name="vccmark"; } _23.src=ContentCommon.prefix+"vcc/images/elementcomments.gif"; _23.style.border="none"; _23.onclick=function(){ ContentCommon.onMarkerClicked(this); }; _23.ranges=[]; _23.next=0; _23._vccmark=true; return _23; },_showMarker:function(_24){ var _25; var _26; if(_24.type=="page"){ return; }else{ if(_24.type=="element"){ _25=this._document.getElementById(_24.target); if(_25.firstChild){ if(_25.firstChild._vccmark){ _26=_25.firstChild; }else{ _26=this._createMarker(); _25.insertBefore(_26,_25.firstChild); } }else{ if(_25.previousSibling&&_25.previousSibling._vccmark){ _26=_25.previousSibling; }else{ _26=this._createMarker(); _25.parentNode.insertBefore(_26,_25); } } }else{ if(_24.type=="free"){ var _27=_24.target; var _28=this._document.getElementById(_27.start.id); var _29=FreeSelect._UTIL._restoreIndex(_28,_27.start.index,true); _25=_28.childNodes[_29]; if(_25.previousSibling&&_25.previousSibling._vccmark){ _26=_25.previousSibling; }else{ _26=this._createMarker(); _25.parentNode.insertBefore(_26,_25); } } } } if(_26){ for(var i in _26.ranges){ if(_24.equals(_26.ranges[i])){ return; } } _26.ranges.push(_24.clone()); } },hideAllMarkers:function(){ var _2b=this._document.getElementsByName("vccmark"); var _2c=[]; for(var i=0;i<_2b.length;++i){ _2c[i]=_2b[i]; } for(var i=0;i<_2c.length;++i){ var _2e=_2c[i]; if(_2e.parentNode){ _2e.parentNode.removeChild(_2e); } } },hideMarkers:function(_2f){ if(null==_2f){ return; } for(var i in _2f){ this._hideMarker(_2f[i]); } },_hideMarker:function(_31){ var _32; var _33; if(_31.type=="page"){ return; }else{ if(_31.type=="element"){ _32=this._document.getElementById(_31.target); if(_32.firstChild){ if(_32.firstChild._vccmark){ _33=_32.firstChild; } }else{ if(_32.previousSibling&&_32.previousSibling._vccmark){ _33=_32.previousSibling; } } }else{ if(_31.type=="free"){ var _34=_31.target; var _35=this._document.getElementById(_34.start.id); var _36=FreeSelect._UTIL._restoreIndex(_35,_34.start.index,true); _32=_35.childNodes[_36]; if(_32.previousSibling&&_32.previousSibling._vccmark){ _33=_32.previousSibling; } } } } if(_33){ _33.parentNode.removeChild(_33); } }}); dojo.declare("vcc.content.DocParser",null,{parsed:false,parse:function(doc){ var _38=doc.body.getAttribute("vcc_parsed"); if(!_38){ this._parse(doc.body); } this.parsed=true; },_parse_id:0,_parse_tab_index:1,_parse:function(_39){ if(_39.id=="rate"||_39.id=="ETSTagCloud"||this._getElementName(_39)=="vcc_noparse"){ return; } if(!_39.id||_39.id==""){ _39.id="vcc_dp_"+_39.tagName+(this._parse_id++); } if(ContentCommon.isIndexAble(_39.tagName)){ _39.tabIndex=(this._parse_tab_index++); } var _3a=_39.childNodes; for(var _3b=0;_3b<_3a.length;_3b++){ this._parse(_3a[_3b]); } },_getElementName:function(_3c){ if(_3c.name){ return _3c.name; }else{ if(_3c.attributes){ for(var i=0;i<_3c.attributes.length;i++){ if(_3c.attributes[i].name=="name"){ return _3c.attributes[i].value; } } } } return null; }}); var ContentCommon={pre_selection:null,prefix:"",tags:["DIV","P","LI","H1","H2","H3","H4","H5","H6","EM","SPAN","UL","FONT","A","TABLE","TD","TH","OL","LABEL","IMG","DL","DT","DD","PRE","STRONG"],isIndexAble:function(_3e){ for(var i=0;i<this.tags.length;i++){ if(this.tags[i]==_3e){ return true; } } return false; },isValidNode:function(_40){ if(!_40){ return false; }else{ return !_40.vcc_noparse&&_40.tabIndex&&_40.tabIndex>0&&this.isIndexAble(_40.tagName); } },onMarkerClicked:function(_41){ if(_41.next==_41.ranges.length){ _41.next=0; var _42=_41.ranges[0]; if(this.pre_selection==_42){ content.selectFragmentAndDisplayComment(new FreeSelect.Selection("page",content._targetWindow.document.location.href)); }else{ content.selectFragmentAndDisplayComment(_42); this.pre_selection=_42; _41.next++; } }else{ var _42=_41.ranges[_41.next++]; this.pre_selection=_42; content.selectFragmentAndDisplayComment(_42); } },onPopupClicked:function(_43){ content.selectFragmentAndDisplayComment(new FreeSelect.Selection("element",_43.goTarget.id)); },_mouseDownHander:function(e){ content._freeSelector.clearSelection(); },_mouseUpHander:function(e){ if(isIE){ ev=content._targetWindow.event; }else{ ev=e; } content._selectHandler(ev,true); },_keyDownHandler:function(e){ if(isIE){ ev=content._targetWindow.event; }else{ ev=e; } switch(ev.keyCode){ case 13: content._selectHandler(ev,false); break; } }}; dojo.declare("vcc.content.Content",null,{constructor:function(_47){ this._targetWindow=_47; FreeSelect.setWindow(_47); this._freeSelector=FreeSelect.getInstance(); this._highlighter=new vcc.content.Highlighter(_47,this._freeSelector); this._scroller=new vcc.base.Scroller(_47); this._marker=new vcc.content.Marker(_47.document); this._docParser=new vcc.content.DocParser(); this.currentSelection=new FreeSelect.Selection("page",document.location.href); },initialize:function(_48){ this._docParser.parse(this._targetWindow.document); this._commentViewWrapper=_48; FreeSelect.fixPreOffset(); },toSelection:function(str){ return FreeSelect.create(decodeURIComponent(str)); },markSelection:function(_4a){ this._marker._showMarker(_4a); },clearMarkers:function(){ this._marker.hideAllMarkers(); },highlightSelection:function(_4b){ this._highlighter.highlightFragment(_4b); },clearHighlight:function(){ this._highlighter.clearHighlight(); },selectFragmentAndDisplayComment:function(_4c,_4d){ this.selectFragment(_4c,_4d); if(this._commentViewWrapper&&this._commentViewWrapper.commentView){ this._commentViewWrapper.commentView.showCommentsForSelection(_4c); } },selectFragment:function(_4e,_4f){ if(_4f){ if(_4e.type=="page"){ }else{ if(_4e.type=="element"){ this._scroller.scrollToElement(_4e.target); }else{ if(_4e.type=="free"){ this._scroller.scrollToElement(_4e.target.start.id); } } } } this._highlighter.highlightFragment(_4e); this.currentSelection=_4e; if(this._commentViewWrapper&&this._commentViewWrapper.commentView){ this._commentViewWrapper.commentView.showCommentsForSelection(_4e); } },disableClickHandler:function(){ if(isMozilla){ this._targetWindow.document.removeEventListener("mousedown",ContentCommon._mouseDownHander,true); this._targetWindow.document.removeEventListener("mouseup",ContentCommon._mouseUpHander,true); this._targetWindow.document.removeEventListener("keydown",ContentCommon._keyDownHandler,true); }else{ if(isIE){ this._targetWindow.document.detachEvent("onmousedown",ContentCommon._mouseDownHander); this._targetWindow.document.detachEvent("onmouseup",ContentCommon._mouseUpHander); this._targetWindow.document.detachEvent("onkeydown",ContentCommon._keyDownHandler); } } },enableClickHandler:function(){ if(isMozilla){ this._targetWindow.document.addEventListener("mousedown",ContentCommon._mouseDownHander,true); this._targetWindow.document.addEventListener("mouseup",ContentCommon._mouseUpHander,true); this._targetWindow.document.addEventListener("keydown",ContentCommon._keyDownHandler,true); }else{ if(isIE){ this._targetWindow.document.detachEvent("onmousedown",ContentCommon._mouseDownHander); this._targetWindow.document.attachEvent("onmousedown",ContentCommon._mouseDownHander); this._targetWindow.document.detachEvent("onmouseup",ContentCommon._mouseUpHander); this._targetWindow.document.attachEvent("onmouseup",ContentCommon._mouseUpHander); this._targetWindow.document.detachEvent("onkeydown",ContentCommon._keyDownHandler); this._targetWindow.document.attachEvent("onkeydown",ContentCommon._keyDownHandler); } } },_selectHandler:function(e,_51){ var _52; if(isIE){ _52=e.srcElement; }else{ if(isMozilla){ _52=e.target; }else{ alert(nlsStrings.ALERT_IE_MOZILA); } } if(_52&&(_52._vccmark||_52._vccpopup)){ return; } if(this._freeSelector.isEmptySelection()){ if(_51&&_52.tagName=="A"){ return; } var _53=this._getSelectedElement(_52); if(_53){ this.currentSelection=new FreeSelect.Selection("element",_53.id); }else{ this.currentSelection=new FreeSelect.Selection("page",document.location.href); } }else{ var _54=this._freeSelector.getSelection(); if(_54){ var _55=_54.parent.id; var _56=_54.start.id; var _57=document.getElementById(_55).tagName; if(_55==_56&&_57=="BODY"){ this._freeSelector.clearSelection(); return; } this.currentSelection=new FreeSelect.Selection("free",this._freeSelector.getSelection()); this._freeSelector.clearSelection(); }else{ this.currentSelection=new FreeSelect.Selection("page",document.location.href); } } this.selectFragmentAndDisplayComment(this.currentSelection,false); },_getSelectedElement:function(_58){ while(!ContentCommon.isValidNode(_58)){ if(_58.parentNode){ _58=_58.parentNode; }else{ return null; } } if(this.currentSelection.type=="element"&&_58.id==this.currentSelection.target){ return null; }else{ return _58; } }}); 